{"version":3,"file":"ActivityTab-9525fbd4.mjs","sources":["../src/utils/api.ts","../src/components/ActivitySidebarPlugin.vue","../src/views/ActivityTab.vue"],"sourcesContent":["/**\n * @copyright Copyright (c) 2023 Ferdinand Thiessen <opensource@fthiessen.de>\n *\n * @author Ferdinand Thiessen <opensource@fthiessen.de>\n *\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\nimport type { ActivityFactoryQueryOptions, IActivityFactory, IActivityFilter, IActivitySidebarAction } from '../models/ActivityAPI'\nimport logger from './logger'\n\ndeclare global {\n\tinterface Window {\n\t\tOC: Nextcloud.v27.OC\n\t\tOCA?: {\n\t\t\tViewer?: {\n\t\t\t\topen(options: { path?: string, fileInfo?: unknown }): void\n\t\t\t\tget mimetypes(): string[]\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport class ActivityAPI {\n\n\tstatic pluginName = 'OCA.Activity.SidebarPlugin'\n\n\t#sidebar_actions = [] as IActivitySidebarAction[]\n\t#sidebar_factories = [] as IActivityFactory[]\n\t#sidebar_filters = [] as IActivityFilter[]\n\n\tconstructor() {\n\t\twindow.OC.Plugins.attach(ActivityAPI.pluginName, this)\n\t}\n\n\tpublic destroy() {\n\t\twindow.OC.Plugins.detach(ActivityAPI.pluginName, this)\n\t\tthis.#sidebar_actions = []\n\t\tthis.#sidebar_factories = []\n\t\tthis.#sidebar_filters = []\n\t}\n\n\tpublic reload() {\n\t\tthis.destroy()\n\t\twindow.OC.Plugins.attach(ActivityAPI.pluginName, this)\n\t}\n\n\t/**\n\t * Register an external action that should be shown in the Activity sidebar panel\n\t * @param action the action\n\t */\n\tpublic registerSidebarAction(action: IActivitySidebarAction) {\n\t\tthis.#sidebar_actions.push(action)\n\t\tlogger.debug('Registered new sidebar action')\n\t}\n\n\t/**\n\t * Register a factory to provide activities not included in the stream\n\t * @param factory the factory\n\t */\n\tpublic registerSidebarEntries(factory: IActivityFactory) {\n\t\tthis.#sidebar_factories.push(factory)\n\t\tlogger.debug('Registered new sidebar entry factory')\n\t}\n\n\t/**\n\t * Register an filter function to filter out activities on the sidebar, useful together with `registerSidebarEntries`\n\t * @param filter The filter to apply\n\t */\n\tpublic registerSidebarFilter(filter: IActivityFilter) {\n\t\tthis.#sidebar_filters.push(filter)\n\t\tlogger.debug('Registered new sidebar filter')\n\t}\n\n\t/**\n\t * Get all external actions that should be showed in the Activity panel\n\t */\n\tpublic getSidebarActions() {\n\t\treturn this.#sidebar_actions ?? []\n\t}\n\n\t/**\n\t * Get all additional activity stream entries for a given file object\n\t * @param options Filter options for the additonal entries\n\t */\n\tpublic async getAdditionalEntries(options: ActivityFactoryQueryOptions) {\n\t\tif (this.#sidebar_factories === undefined) {\n\t\t\treturn []\n\t\t}\n\n\t\tconst allPromises = this.#sidebar_factories.map(async (factory) => await factory(options))\n\t\treturn (await Promise.all(allPromises)).flat()\n\t}\n\n\t/**\n\t * Get all sidebar entry filters\n\t */\n\tpublic getActivityFilters() {\n\t\treturn this.#sidebar_filters ?? []\n\t}\n\n}\n\nlet api: ActivityAPI | undefined\nlet numberKnownPlugins = 0\n\n/**\n * Get cached sidebar api or reload on changes\n */\nexport const getSidebarApi = () => {\n\tconst numberPlugins = window.OC.Plugins.getPlugins(ActivityAPI.pluginName).length\n\n\tif (!api) {\n\t\tapi = new ActivityAPI()\n\t} else if (numberKnownPlugins !== numberPlugins) {\n\t\tapi.reload()\n\t}\n\n\tnumberKnownPlugins = numberPlugins\n\treturn api\n}\n","<!--\n  - @copyright Copyright (c) 2023 Ferdinand Thiessen <opensource@fthiessen.de>\n  -\n  - @author Ferdinand Thiessen <opensource@fthiessen.de>\n  -\n  - @license AGPL-3.0-or-later\n  -\n  - This program is free software: you can redistribute it and/or modify\n  - it under the terms of the GNU Affero General Public License as\n  - published by the Free Software Foundation, either version 3 of the\n  - License, or (at your option) any later version.\n  -\n  - This program is distributed in the hope that it will be useful,\n  - but WITHOUT ANY WARRANTY; without even the implied warranty of\n  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n  - GNU Affero General Public License for more details.\n  -\n  - You should have received a copy of the GNU Affero General Public License\n  - along with this program. If not, see <http://www.gnu.org/licenses/>.\n  -\n  -->\n\n<template>\n\t<div ref=\"attachTarget\" />\n</template>\n\n<script setup lang=\"ts\">\nimport type { IActivitySidebarAction } from '../models/ActivityAPI'\nimport { getCurrentInstance, onBeforeUnmount, onMounted, ref } from 'vue'\n\nconst props = defineProps<{\n\t/** The sidebar plugin */\n\tplugin: IActivitySidebarAction\n  fileInfo: object | null\n}>()\n\nconst emit = defineEmits<{\n\t(e: 'reload-activities'): void\n}>()\n\nconst attachTarget = ref<HTMLDivElement>()\n\nonMounted(() => props.plugin.mount(attachTarget.value as HTMLDivElement, {\n\tcontext: getCurrentInstance()?.proxy,\n\tfileInfo: props.fileInfo,\n\treload: () => emit('reload-activities'),\n}))\nonBeforeUnmount(() => props.plugin.unmount())\n</script>\n","<!--\n  - @copyright Copyright (c) 2021 Louis Chemineau <louis@chmn.me>\n  -\n  - @author Louis Chemineau <louis@chmn.me>\n  -\n  - @license AGPL-3.0-or-later\n  -\n  - This program is free software: you can redistribute it and/or modify\n  - it under the terms of the GNU Affero General Public License as\n  - published by the Free Software Foundation, either version 3 of the\n  - License, or (at your option) any later version.\n  -\n  - This program is distributed in the hope that it will be useful,\n  - but WITHOUT ANY WARRANTY; without even the implied warranty of\n  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n  - GNU Affero General Public License for more details.\n  -\n  - You should have received a copy of the GNU Affero General Public License\n  - along with this program. If not, see <http://www.gnu.org/licenses/>.\n  -\n  -->\n\n<template>\n\t<div :class=\"{ 'icon-loading': loading }\">\n\t\t<!-- error message -->\n\t\t<NcEmptyContent v-if=\"error\" :name=\"error\">\n\t\t\t<template #icon>\n\t\t\t\t<NcIconSvgWrapper :svg=\"lightningBoltSVG\" />\n\t\t\t</template>\n\t\t</NcEmptyContent>\n\t\t<template v-else>\n\t\t\t<!-- activities actions -->\n\t\t\t<div v-if=\"sidebarPlugins.length > 0\" class=\"activity__actions\">\n\t\t\t\t<ActivitySidebarPlugin v-for=\"plugin,index of sidebarPlugins\"\n\t\t\t\t\t:key=\"index\"\n\t\t\t\t\t:plugin=\"plugin\"\n\t\t\t\t\t:file-info=\"fileInfo\"\n\t\t\t\t\t@reload-activities=\"getActivities()\" />\n\t\t\t</div>\n\n\t\t\t<!-- activities content -->\n\t\t\t<NcEmptyContent v-if=\"loading\"\n\t\t\t\t:name=\"t('activity', 'Loading activities')\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<NcLoadingIcon />\n\t\t\t\t</template>\n\t\t\t</NcEmptyContent>\n\t\t\t<NcEmptyContent v-else-if=\"activities.length === 0\"\n\t\t\t\t:name=\"t('activity', 'No activity yet')\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<span class=\"icon-activity\" />\n\t\t\t\t</template>\n\t\t\t</NcEmptyContent>\n\t\t\t<ul v-else>\n\t\t\t\t<Activity v-for=\"activity in activities\"\n\t\t\t\t\t:key=\"activity.id\"\n\t\t\t\t\t:activity=\"activity\"\n\t\t\t\t\t:show-previews=\"false\"\n\t\t\t\t\t@reload=\"getActivities()\" />\n\t\t\t</ul>\n\t\t</template>\n\t</div>\n</template>\n\n<script>\nimport axios from '@nextcloud/axios'\n\nimport { generateOcsUrl } from '@nextcloud/router'\nimport { translate as t } from '@nextcloud/l10n'\nimport { NcEmptyContent, NcIconSvgWrapper, NcLoadingIcon } from '@nextcloud/vue'\nimport { getSidebarApi } from '../utils/api.ts'\n\nimport logger from '../utils/logger.ts'\nimport Activity from '../components/Activity.vue'\nimport ActivityModel from '../models/ActivityModel.ts'\nimport ActivitySidebarPlugin from '../components/ActivitySidebarPlugin.vue'\n\nimport lightningBoltSVG from '@mdi/svg/svg/lightning-bolt.svg?raw'\n\nexport default {\n\tname: 'ActivityTab',\n\tcomponents: {\n\t\tActivity,\n\t\tNcEmptyContent,\n\t\tNcIconSvgWrapper,\n\t\tNcLoadingIcon,\n\t\tActivitySidebarPlugin,\n\t},\n\tdata() {\n\t\treturn {\n\t\t\terror: '',\n\t\t\tloading: true,\n\t\t\tfileInfo: null,\n\t\t\tactivities: [],\n\t\t\tlightningBoltSVG,\n\t\t\tsidebarPlugins: [],\n\t\t}\n\t},\n\tmounted() {\n\t\tthis.sidebarPlugins = getSidebarApi().getSidebarActions()\n\t},\n\tmethods: {\n\t\t/**\n\t\t * Update current fileInfo and fetch new activities\n\t\t *\n\t\t * @param {object} fileInfo the current file FileInfo\n\t\t */\n\t\tasync update(fileInfo) {\n\t\t\tthis.fileInfo = fileInfo\n\t\t\tthis.resetState()\n\t\t\tawait this.getActivities()\n\t\t},\n\t\t/**\n\t\t * Get the existing activities\n\t\t */\n\t\tasync getActivities() {\n\t\t\ttry {\n\t\t\t\tthis.loading = true\n\n\t\t\t\tconst activities = this.processActivities(await axios.get(\n\t\t\t\t\tgenerateOcsUrl('apps/activity/api/v2/activity/filter'),\n\t\t\t\t\t{\n\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\tformat: 'json',\n\t\t\t\t\t\t\tobject_type: 'files',\n\t\t\t\t\t\t\tobject_id: this.fileInfo.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t))\n\t\t\t\tconst other = await getSidebarApi().getAdditionalEntries({ fileInfo: this.fileInfo })\n\t\t\t\tthis.activities = [...activities, ...other].sort((a, b) => b.timestamp - a.timestamp)\n\t\t\t} catch (error) {\n\t\t\t\t// Status 304 is not an error.\n\t\t\t\tif (error.response !== undefined && error.response.status === 304) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tthis.error = t('activity', 'Unable to load the activity list')\n\t\t\t\tconsole.error('Error loading the activity list', error)\n\t\t\t} finally {\n\t\t\t\tthis.loading = false\n\t\t\t}\n\t\t},\n\t\t/**\n\t\t * Reset the current view to its default state\n\t\t */\n\t\tresetState() {\n\t\t\tthis.loading = true\n\t\t\tthis.error = ''\n\t\t\tthis.activities = []\n\t\t},\n\t\t/**\n\t\t * Process the current activity data\n\t\t *\n\t\t * @param {object} activity the activity ocs api request data\n\t\t * @param {object} activity.data the request data\n\t\t */\n\t\tprocessActivities({ data }) {\n\t\t\tif (data.ocs && data.ocs.data && data.ocs.data.length > 0) {\n\t\t\t\t// create Activity objects and sort by newest\n\t\t\t\tconst activities = data.ocs.data\n\t\t\t\t\t.map(activity => new ActivityModel(activity))\n\n\t\t\t\tlogger.debug(`Processed ${activities.length} activity(ies)`, { activities, fileInfo: this.fileInfo })\n\n\t\t\t\tconst filters = getSidebarApi().getActivityFilters()\n\t\t\t\treturn activities.filter((activity) => !filters || filters.every((filter) => filter(activity)))\n\t\t\t}\n\t\t},\n\n\t\tt,\n\t},\n}\n</script>\n\n<style scoped lang=\"scss\">\n:deep(.empty-content__icon span) {\n\tbackground-size: 64px;\n\twidth: 64px;\n\theight: 64px;\n}\n\n.activity__actions {\n\tdisplay: flex;\n\tflex-direction: column;\n\twidth: 100%;\n}\n</style>\n"],"names":["ActivityAPI","#sidebar_actions","#sidebar_factories","#sidebar_filters","action","logger","factory","filter","options","allPromises","api","numberKnownPlugins","getSidebarApi","numberPlugins","attachTarget","ref","onMounted","props","getCurrentInstance","emit","onBeforeUnmount","_sfc_main","Activity","NcEmptyContent","NcIconSvgWrapper","NcLoadingIcon","ActivitySidebarPlugin","lightningBoltSVG","fileInfo","activities","axios","generateOcsUrl","other","a","b","error","t","data","activity","ActivityModel","filters"],"mappings":"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"}