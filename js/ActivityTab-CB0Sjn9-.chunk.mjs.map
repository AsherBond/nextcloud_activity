{"version":3,"file":"ActivityTab-CB0Sjn9-.chunk.mjs","sources":["../src/components/ActivitySidebarPlugin.vue","../src/views/ActivityTab.vue"],"sourcesContent":["<!--\n  - SPDX-FileCopyrightText: 2023 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<div ref=\"attachTarget\" />\n</template>\n\n<script setup lang=\"ts\">\nimport type { IActivitySidebarAction } from '../models/ActivityAPI.ts'\n\nimport { getCurrentInstance, onBeforeUnmount, onMounted, ref } from 'vue'\n\nconst props = defineProps<{\n\t/** The sidebar plugin */\n\tplugin: IActivitySidebarAction\n\tfileInfo: object | null\n}>()\n\nconst emit = defineEmits<{\n\t(e: 'reload-activities'): void\n}>()\n\nconst attachTarget = ref<HTMLDivElement>()\n\nonMounted(() => props.plugin.mount(attachTarget.value as HTMLDivElement, {\n\tcontext: getCurrentInstance()?.proxy,\n\tfileInfo: props.fileInfo,\n\treload: () => emit('reload-activities'),\n}))\nonBeforeUnmount(() => props.plugin.unmount())\n</script>\n","<!--\n  - SPDX-FileCopyrightText: 2021 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<div\n\t\t:class=\"{ 'icon-loading': loading }\"\n\t\tclass=\"activity\">\n\t\t<!-- error message -->\n\t\t<NcEmptyContent v-if=\"error\" :name=\"error\">\n\t\t\t<template #icon>\n\t\t\t\t<NcIconSvgWrapper :svg=\"lightningBoltSVG\" />\n\t\t\t</template>\n\t\t</NcEmptyContent>\n\t\t<template v-else>\n\t\t\t<!-- activities actions -->\n\t\t\t<div v-if=\"sidebarPlugins.length > 0\" class=\"activity__actions\">\n\t\t\t\t<ActivitySidebarPlugin\n\t\t\t\t\tv-for=\"plugin, index of sidebarPlugins\"\n\t\t\t\t\t:key=\"index\"\n\t\t\t\t\t:plugin=\"plugin\"\n\t\t\t\t\t:file-info=\"fileInfo\"\n\t\t\t\t\t@reload-activities=\"getActivities()\" />\n\t\t\t</div>\n\n\t\t\t<!-- activities content -->\n\t\t\t<NcEmptyContent\n\t\t\t\tv-if=\"loading\"\n\t\t\t\tclass=\"activity__empty-content\"\n\t\t\t\t:name=\"t('activity', 'Loading activities')\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<NcLoadingIcon />\n\t\t\t\t</template>\n\t\t\t</NcEmptyContent>\n\t\t\t<NcEmptyContent\n\t\t\t\tv-else-if=\"activities.length === 0\"\n\t\t\t\tclass=\"activity__empty-content\"\n\t\t\t\t:name=\"t('activity', 'No activity yet')\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<span class=\"icon-activity\" />\n\t\t\t\t</template>\n\t\t\t</NcEmptyContent>\n\t\t\t<ul v-else class=\"activity__list\">\n\t\t\t\t<ActivityComponent\n\t\t\t\t\tv-for=\"activity in activities\"\n\t\t\t\t\t:key=\"activity.id\"\n\t\t\t\t\t:activity=\"activity\"\n\t\t\t\t\t:show-previews=\"false\"\n\t\t\t\t\t@reload=\"getActivities()\" />\n\t\t\t</ul>\n\t\t</template>\n\t</div>\n</template>\n\n<script>\nimport lightningBoltSVG from '@mdi/svg/svg/lightning-bolt.svg?raw'\nimport axios from '@nextcloud/axios'\nimport { translate as t } from '@nextcloud/l10n'\nimport { generateOcsUrl } from '@nextcloud/router'\nimport NcEmptyContent from '@nextcloud/vue/dist/Components/NcEmptyContent.js'\nimport NcIconSvgWrapper from '@nextcloud/vue/dist/Components/NcIconSvgWrapper.js'\nimport NcLoadingIcon from '@nextcloud/vue/dist/Components/NcLoadingIcon.js'\nimport ActivityComponent from '../components/ActivityComponent.vue'\nimport ActivitySidebarPlugin from '../components/ActivitySidebarPlugin.vue'\nimport ActivityModel from '../models/ActivityModel.ts'\nimport { getActivityFilters, getAdditionalEntries, getSidebarActions } from '../utils/api.ts'\nimport logger from '../utils/logger.ts'\n\nexport default {\n\tname: 'ActivityTab',\n\tcomponents: {\n\t\tActivityComponent,\n\t\tNcEmptyContent,\n\t\tNcIconSvgWrapper,\n\t\tNcLoadingIcon,\n\t\tActivitySidebarPlugin,\n\t},\n\n\tdata() {\n\t\treturn {\n\t\t\terror: '',\n\t\t\tloading: true,\n\t\t\tfileInfo: null,\n\t\t\tactivities: [],\n\t\t\tlightningBoltSVG,\n\t\t\tsidebarPlugins: [],\n\t\t}\n\t},\n\n\tmounted() {\n\t\tthis.sidebarPlugins = getSidebarActions()\n\t},\n\n\tmethods: {\n\t\t/**\n\t\t * Update current fileInfo and fetch new activities\n\t\t *\n\t\t * @param fileInfo the current file FileInfo\n\t\t */\n\t\tasync update(fileInfo) {\n\t\t\tthis.sidebarPlugins = []\n\t\t\tconst sidebarPlugins = getSidebarActions()\n\t\t\tif (sidebarPlugins.length > 0) {\n\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\tthis.sidebarPlugins = sidebarPlugins\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tthis.fileInfo = fileInfo\n\t\t\tthis.resetState()\n\t\t\tawait this.getActivities()\n\t\t},\n\n\t\t/**\n\t\t * Get the existing activities\n\t\t */\n\t\tasync getActivities() {\n\t\t\ttry {\n\t\t\t\tthis.loading = true\n\n\t\t\t\tconst activities = await this.processActivities(await this.loadRealActivities())\n\t\t\t\tconst otherEntries = await getAdditionalEntries({ fileInfo: this.fileInfo })\n\t\t\t\tthis.activities = [...activities, ...otherEntries].sort((a, b) => b.timestamp - a.timestamp)\n\t\t\t} catch (error) {\n\t\t\t\tthis.error = t('activity', 'Unable to load the activity list')\n\t\t\t\tlogger.error('Error loading the activity list', { error })\n\t\t\t} finally {\n\t\t\t\tthis.loading = false\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Reset the current view to its default state\n\t\t */\n\t\tresetState() {\n\t\t\tthis.loading = true\n\t\t\tthis.error = ''\n\t\t\tthis.activities = []\n\t\t},\n\n\t\t/**\n\t\t * Load activites from API\n\t\t */\n\t\tasync loadRealActivities() {\n\t\t\ttry {\n\t\t\t\tconst { data } = await axios.get(\n\t\t\t\t\tgenerateOcsUrl('apps/activity/api/v2/activity/filter'),\n\t\t\t\t\t{\n\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\tformat: 'json',\n\t\t\t\t\t\t\tobject_type: 'files',\n\t\t\t\t\t\t\tobject_id: this.fileInfo.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t\treturn data.ocs.data\n\t\t\t} catch (error) {\n\t\t\t\t// Status 304 is not an error.\n\t\t\t\tif (error.response !== undefined && error.response.status === 304) {\n\t\t\t\t\treturn []\n\t\t\t\t}\n\t\t\t\tthrow e\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Process the API response activities and apply filter\n\t\t *\n\t\t * @param activities the activites\n\t\t */\n\t\tprocessActivities(activities) {\n\t\t\tactivities = activities.map((activity) => new ActivityModel(activity))\n\n\t\t\tlogger.debug(`Processed ${activities.length} activity(ies)`, { activities, fileInfo: this.fileInfo })\n\n\t\t\tconst filters = getActivityFilters()\n\t\t\treturn activities.filter((activity) => !filters || filters.every((filter) => filter(activity)))\n\t\t},\n\n\t\tt,\n\t},\n}\n</script>\n\n<style scoped lang=\"scss\">\n.activity {\n\tdisplay: flex;\n\tflex-direction: column;\n\toverflow: hidden;\n\theight: 100%;\n\n\t&__actions {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\twidth: 100%;\n\t}\n\n\t&__list {\n\t\tflex-grow: 1;\n\t\toverflow: scroll;\n\t}\n\n\t&__empty-content {\n\t\theight: 100%;\n\t}\n}\n\n:deep(.empty-content__icon span) {\n\tbackground-size: 64px;\n\twidth: 64px;\n\theight: 64px;\n}\n</style>\n"],"names":["attachTarget","ref","onMounted","props","getCurrentInstance","emit","onBeforeUnmount","_sfc_main","ActivityComponent","NcEmptyContent","NcIconSvgWrapper","NcLoadingIcon","ActivitySidebarPlugin","lightningBoltSVG","getSidebarActions","fileInfo","sidebarPlugins","activities","otherEntries","getAdditionalEntries","a","b","error","t","logger","data","axios","generateOcsUrl","activity","ActivityModel","filters","getActivityFilters","filter"],"mappings":"8mBAwBMA,EAAeC,EAAoB,EAEzC,OAAAC,EAAU,IAAMC,EAAM,OAAO,MAAMH,EAAa,MAAyB,CACxE,QAASI,KAAsB,MAC/B,SAAUD,EAAM,SAChB,OAAQ,IAAME,EAAK,mBAAmB,CAAA,CACtC,CAAC,EACFC,EAAgB,IAAMH,EAAM,OAAO,QAAA,CAAS,gMCsC5CI,EAAA,CACA,KAAA,cACA,WAAA,CACA,kBAAAC,EACA,eAAAC,EACA,iBAAAC,EACA,cAAAC,EACA,sBAAAC,CACA,EAEA,MAAA,CACA,MAAA,CACA,MAAA,GACA,QAAA,GACA,SAAA,KACA,WAAA,CAAA,EACA,iBAAAC,EACA,eAAA,CAAA,CACA,CACA,EAEA,SAAA,CACA,KAAA,eAAAC,EAAA,CACA,EAEA,QAAA,CAMA,MAAA,OAAAC,EAAA,CACA,KAAA,eAAA,CAAA,EACA,MAAAC,EAAAF,EAAA,EACAE,EAAA,OAAA,GACA,KAAA,UAAA,IAAA,CACA,KAAA,eAAAA,CACA,CAAA,EAGA,KAAA,SAAAD,EACA,KAAA,WAAA,EACA,MAAA,KAAA,cAAA,CACA,EAKA,MAAA,eAAA,CACA,GAAA,CACA,KAAA,QAAA,GAEA,MAAAE,EAAA,MAAA,KAAA,kBAAA,MAAA,KAAA,mBAAA,CAAA,EACAC,EAAA,MAAAC,EAAA,CAAA,SAAA,KAAA,QAAA,CAAA,EACA,KAAA,WAAA,CAAA,GAAAF,EAAA,GAAAC,CAAA,EAAA,KAAA,CAAAE,EAAAC,IAAAA,EAAA,UAAAD,EAAA,SAAA,CACA,OAAAE,EAAA,CACA,KAAA,MAAAC,EAAA,WAAA,kCAAA,EACAC,EAAA,MAAA,kCAAA,CAAA,MAAAF,CAAA,CAAA,CACA,QAAA,CACA,KAAA,QAAA,EACA,CACA,EAKA,YAAA,CACA,KAAA,QAAA,GACA,KAAA,MAAA,GACA,KAAA,WAAA,CAAA,CACA,EAKA,MAAA,oBAAA,CACA,GAAA,CACA,KAAA,CAAA,KAAAG,CAAA,EAAA,MAAAC,EAAA,IACAC,EAAA,sCAAA,EACA,CACA,OAAA,CACA,OAAA,OACA,YAAA,QACA,UAAA,KAAA,SAAA,EACA,CACA,CACA,EACA,OAAAF,EAAA,IAAA,IACA,OAAAH,EAAA,CAEA,GAAAA,EAAA,WAAA,QAAAA,EAAA,SAAA,SAAA,IACA,MAAA,CAAA,EAEA,MAAA,CACA,CACA,EAOA,kBAAAL,EAAA,CACAA,EAAAA,EAAA,IAAAW,GAAA,IAAAC,EAAAD,CAAA,CAAA,EAEAJ,EAAA,MAAA,aAAAP,EAAA,MAAA,iBAAA,CAAA,WAAAA,EAAA,SAAA,KAAA,QAAA,CAAA,EAEA,MAAAa,EAAAC,EAAA,EACA,OAAAd,EAAA,OAAAW,GAAA,CAAAE,GAAAA,EAAA,MAAAE,GAAAA,EAAAJ,CAAA,CAAA,CAAA,CACA,EAEA,EAAAL,CACA,CACA"}