function escapeHTML(t){return t.toString().split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;").split("'").join("&#039;")}$((function(){OCA.Activity=OCA.Activity||{},OCA.Activity.Filter={filter:void 0,defaultPageTitle:void 0,$navigation:$("#app-navigation"),_onPopState:function(t){t=_.extend({filter:"all"},t),this.setFilter(t.filter)},setFilter:function(t){if(t!==this.filter){this.defaultPageTitle||(this.defaultPageTitle=window.document.title),this.$navigation.find("a[data-navigation="+this.filter+"]").parent().removeClass("active").removeAttr("aria-current"),OCA.Activity.InfinitScrolling.firstKnownId=0,OCA.Activity.InfinitScrolling.lastGivenId=0,this.filter=t,OCA.Activity.InfinitScrolling.$container.animate({scrollTop:0},"slow"),OCA.Activity.InfinitScrolling.$container.children().remove(),$("#emptycontent").addClass("hidden"),$("#no_more_activities").addClass("hidden"),$("#loading_activities").removeClass("hidden"),OCA.Activity.InfinitScrolling.ignoreScroll=0;var i=this.$navigation.find("a[data-navigation="+t+"]");i.parent().addClass("active").attr("aria-current","page"),window.document.title=i.text().trim()+" - "+this.defaultPageTitle,OCP.Accessibility.setPageHeading(i.text().trim()),OCA.Activity.InfinitScrolling.prefill()}}},OCA.Activity.InfinitScrolling={ignoreScroll:0,$container:$("#container"),lastDateGroup:null,$content:$("#app-content"),firstKnownId:0,lastGivenId:0,activities:{},prefill:function(){this.ignoreScroll+=1,this.$content.scrollTop()+$(window).height()>this.$container.height()-100&&(this.ignoreScroll+=1,this.loadMoreActivities()),this.ignoreScroll-=1},onScroll:function(){this.ignoreScroll<=0&&this.$content.scrollTop()+$(window).height()>this.$container.height()-100&&(this.ignoreScroll=1,this.loadMoreActivities())},loadMoreActivities:function(){var t=this;$.ajax({url:OC.linkToOCS("apps/activity/api/v2/activity",2)+OCA.Activity.Filter.filter+"?format=json&previews=true&since="+t.lastGivenId,type:"GET",beforeSend:function(t){t.setRequestHeader("Accept-Language",OC.getLanguage())},success:function(i,e,a){if("notmodified"===e)return t.handleActivitiesCallback([]),void t.saveHeaders(a.getAllResponseHeaders());"nocontent"===e&&(t.handleActivitiesCallback([]),t.ignoreScroll-=1),t.saveHeaders(a.getAllResponseHeaders()),void 0!==i&&(t.handleActivitiesCallback(i.ocs.data),t.ignoreScroll-=1)}})},saveHeaders:function(t){var i=this;t=t.split("\n"),_.each(t,(function(t){var e=t.split(":");"x-activity-first-known"===e[0].toLowerCase()?i.firstKnownId=parseInt(e[1].trim(),10):"x-activity-last-given"===e[0].toLowerCase()&&(i.lastGivenId=parseInt(e[1].trim(),10))}))},handleActivitiesCallback:function(i){if(i.length>0){for(var e=0;e<i.length;e++){var a=i[e];this.appendActivityToContainer(a)}this.prefill()}else if(0===this.$container.children().length){var n=$("#emptycontent");n.removeClass("hidden"),"all"==OCA.Activity.Filter.filter?n.find("p").text(t("activity","This stream will show events like additions, changes & shares")):n.find("p").text(t("activity","There are no events for this filter")),$("#loading_activities").addClass("hidden"),this.ignoreScroll=1}else $("#no_more_activities").removeClass("hidden"),$("#loading_activities").addClass("hidden"),this.ignoreScroll=1},appendActivityToContainer:function(t){t.timestamp=moment(t.datetime).valueOf(),this.makeSureDateGroupExists(t.timestamp),this.activities[t.activity_id]=t,this.addActivity(t)},makeSureDateGroupExists:function(i){var e=OC.Util.formatDate(i,"YYYY-DDD");if(this.$container.children().last().data("date")!==e){var a=OC.Util.formatDate(i,"LL"),n=a;e===OC.Util.formatDate(moment(),"YYYY-DDD")?n=t("activity","Today"):e===OC.Util.formatDate(moment().subtract(1,"d"),"YYYY-DDD")&&(n=t("activity","Yesterday"));var s='<h2 class="section-header" title="'+escapeHTML(a)+'">'+escapeHTML(n)+'</h2>\t<span class="hidden-visually">'+escapeHTML(a)+"</span>\n",r='<ul class="section activity-section group" data-date="'+escapeHTML(e)+'"></ul>',l=$(s);this.processElements(l),this.$container.append(l);var c=$(r);this.processElements(c),this.$container.append(c),this.lastDateGroup=c}},addActivity:function(i){var e=escapeHTML(i.subject);i.subject_rich[0].length>1&&(e=OCA.Activity.RichObjectStringParser.parseMessage(i.subject_rich[0],i.subject_rich[1]));var a=escapeHTML(i.message);i.message_rich[0].length>1&&(a=OCA.Activity.RichObjectStringParser.parseMessage(i.message_rich[0],i.message_rich[1])),e.indexOf("<a")>=0&&(i.link="");var n="file_created"!==i.type&&"file_deleted"!==i.type&&"favorite"!==i.type&&!i.icon.endsWith("-color.svg"),s='<li class="activity box" data-activity-id="'+i.activity_id+'">\n\t<div class="messagecontainer">\n\t\t<div class="activity-icon'+(n?" monochrome":"")+'">'+(i.icon?'\t\t\t<img src="'+i.icon+'" alt="" />':"")+'\t\t</div>\n\t\t<div class="activitysubject">\n'+(i.link?'\t\t\t<a href="'+i.link+'">\n':"")+"\t\t\t"+e+"\n"+(i.link?"\t\t\t</a>\n":"")+'\t\t</div>\n\t\t<span class="hidden-visually">\n\t\t\t'+escapeHTML(OC.Util.formatDate(i.timestamp))+'\n\t\t</span>\n\t\t<span class="activitytime live-relative-timestamp" data-timestamp="'+i.timestamp+'" title="'+escapeHTML(OC.Util.formatDate(i.timestamp))+'">\n\t\t\t'+escapeHTML(OC.Util.relativeModifiedDate(i.timestamp))+"\n\t\t</span>\n";if(a&&(s+='<div class="activitymessage">\n'+a+"\n</div>\n"),i.previews&&i.previews.length){s+='<div class="activity-previews">';for(var r=0;r<i.previews.length;r++){var l=i.previews[r];s+=(l.link?'<a href="'+l.link+'">\n':"")+'<img class="preview'+(l.isMimeTypeIcon?" preview-mimetype-icon":"")+'" src="'+l.source+'" alt="'+t("activity","Open {filename}",l)+'" />\n'+(l.link?"</a>\n":"")}s+="</div>"}s+="\t</div>\n</li>";var c=$(s);this.processElements(c),this.lastDateGroup.append(c)},processElements:function(t){var i=this;t.find(".avatar").each((function(){var t=$(this);t.data("user-display-name")?t.avatar(t.data("user"),21,void 0,!1,void 0,t.data("user-display-name")):t.avatar(t.data("user"),21)})),t.find(".avatar-name-wrapper").each((function(){var t=$(this),i=t.find(".avatar"),e=t.find("strong");$.merge(i,e).contactsMenu(t.data("user"),0,t)})),t.find(".activity-more-link").click((function(){var t=$(this),e=t.closest(".box").data("activity-id"),a=t.closest(".activitysubject"),n=i.activities[e];a.html(i.parseMessage(n.subject_prepared,!0)),i.processElements(a)}))}},OC.Util.History.addOnPopStateHandler(_.bind(OCA.Activity.Filter._onPopState,OCA.Activity.Filter)),OCA.Activity.Filter.setFilter(OCA.Activity.InfinitScrolling.$container.attr("data-activity-filter")),OCA.Activity.InfinitScrolling.$content.on("scroll",_.bind(OCA.Activity.InfinitScrolling.onScroll,OCA.Activity.InfinitScrolling)),OCA.Activity.Filter.$navigation.find("a[data-navigation]").on("click",(function(t){var i=$(this).attr("data-navigation");i!==OCA.Activity.Filter.filter&&OC.Util.History.pushState({filter:i}),OCA.Activity.Filter.setFilter(i),t.preventDefault()}))}));